{% extends "base.html" %}

{% block title %}Risk Assessment Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {{ t('results.title') }}
                    </h2>
                    <p class="mb-0 mt-2">{{ t('results.subtitle') }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <!-- Error Message -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ error }}
            </div>
        </div>
    </div>
    {% endif %}

    {% if results %}
    <!-- Patient Information Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-old text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>{{ t('results.patientInfo') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>{{ t('form.age') }}:</strong> {{ "%.0f"|format(patient_data.get('age', 0)) }} {{ t('form.units.years') }}
                        </div>
                        <div class="col-md-4">
                            <strong>{{ t('form.gender') }}:</strong> {{ t('form.female') if patient_data.get('gender', 0) == 1 else t('form.male') }}
                        </div>
                        <div class="col-md-4">
                            <strong>{{ t('form.bmi') }}:</strong> {{ "%.1f"|format(patient_data.get('bmi', 0)) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Laboratory Values Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flask me-2"></i>{{ t('form.labValues') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.ast') }}</h6>
                                    <span class="h5">{{ "%.0f"|format(patient_data.get('ast', 0)) }} {{ t('form.units.ul') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.alt') }}</h6>
                                    <span class="h5">{{ "%.0f"|format(patient_data.get('alt', 0)) }} {{ t('form.units.ul') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.platelets') }}</h6>
                                    <span class="h5">{{ "%.0f"|format(patient_data.get('trombosit', 0)) }} {{ t('form.units.x10_3_ul') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.albumin') }}</h6>
                                    <span class="h5">{{ "%.1f"|format(patient_data.get('albumin', 0)) }} {{ t('form.units.gdl') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">Total Bilirubin</h6>
                                    <span class="h5">{{ "%.1f"|format(patient_data.get('total_bilirubin', 0)) }} mg/dL</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">Direct Bilirubin</h6>
                                    <span class="h5">{{ "%.1f"|format(patient_data.get('direct_bilirubin', 0)) }} mg/dL</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">INR</h6>
                                    <span class="h5">{{ "%.2f"|format(patient_data.get('inr', 0)) }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">Creatinine</h6>
                                    <span class="h5">{{ "%.1f"|format(patient_data.get('creatinine', 0)) }} mg/dL</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">ALP</h6>
                                    <span class="h5">{{ "%.0f"|format(patient_data.get('alp', 0)) }} U/L</span>
                                </div>
                            </div>
                        </div>
                        {% if has_afp %}
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">AFP</h6>
                                    <span class="h5">{{ "%.1f"|format(patient_data.get('afp', 0)) }} ng/mL</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.ggt') }}</h6>
                                    <span class="h5">{{ "%.0f"|format(patient_data.get('ggt', 0)) }} {{ t('form.units.ul') }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.encephalopathy') }}</h6>
                                    <span class="h5">
                                        {% set enceph_val = patient_data.get('encephalopathy', 0) %}
                                        {% if enceph_val == 1 or enceph_val == 1.0 or enceph_val == "1.0" %}
                                            {{ t('form.encephalopathy_1') }}
                                        {% elif enceph_val == 2 or enceph_val == 2.0 or enceph_val == "2.0" %}
                                            {{ t('form.encephalopathy_2') }}
                                        {% else %}
                                            {{ t('form.encephalopathy_0') }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center py-2">
                                    <h6 class="text-muted mb-1">{{ t('form.ascites') }}</h6>
                                    <span class="h5">
                                        {% set ascites_val = patient_data.get('ascites', 0) %}
                                        {% if ascites_val == 1 or ascites_val == 1.0 or ascites_val == "1.0" %}
                                            {{ t('form.ascites_1') }}
                                        {% elif ascites_val == 2 or ascites_val == 2.0 or ascites_val == "2.0" %}
                                            {{ t('form.ascites_2') }}
                                        {% else %}
                                            {{ t('form.ascites_0') }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Assessment Results -->
    <div class="row mb-4">
        <div class="col-12 mb-3">
            <h4 class="text-enabiz"><i class="fas fa-chart-bar me-2"></i>{{ t('results.riskAssessment') }}</h4>
        </div>
        {% for disease_key, result in results.items() %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-{{ result.get('risk_color', 'secondary') }} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-{{ 'viruses' if disease_key == 'cirrhosis' else 'dna' if disease_key == 'hcc' else 'weight' }} me-2"></i>
                        {{ t('diseases.' + disease_key) }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if result.get('error') %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ t('results.error') }}: {{ result.error }}
                    </div>
                    {% else %}
                    <!-- Risk Level or Classification -->
                    <div class="text-center mb-3">
                        {% if result.get('classification') %}
                        <!-- For NAFLD classification (NAFL vs NASH) -->
                        <span class="badge bg-{{ result.get('risk_color', 'secondary') }} fs-6 p-2">
                            {{ result.get('classification', t('results.unknown')) }}
                        </span>
                        {% if result.get('classification_description') %}
                        <div class="mt-2">
                            <small class="text-muted">{{ result.get('classification_description', '') }}</small>
                        </div>
                        {% endif %}
                        {% else %}
                        <!-- For risk-based assessments (Cirrhosis, HCC) -->
                        <span class="badge bg-{{ result.get('risk_color', 'secondary') }} fs-6 p-2">
                            {{ result.get('risk_level', t('results.unknown')) }} {{ t('results.risk') }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Risk Percentage or Classification Confidence -->
                    <div class="text-center mb-3">
                        {% if result.get('classification') %}
                        <!-- For NAFLD classification confidence -->
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-{{ result.get('risk_color', 'secondary') }}" 
                                 role="progressbar" 
                                 style="width: {{ result.get('confidence', 0) }}%"
                                 aria-valuenow="{{ result.get('confidence', 0) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(result.get('confidence', 0)) }}%
                            </div>
                        </div>
                        <small class="text-muted">{{ t('results.riskProbability') }}: {{ "%.1f"|format(result.get('confidence', 0)) }}%</small>
                        {% else %}
                        <!-- For risk-based assessments -->
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-{{ result.get('risk_color', 'secondary') }}" 
                                 role="progressbar" 
                                 style="width: {{ result.get('risk_percentage', 0) }}%"
                                 aria-valuenow="{{ result.get('risk_percentage', 0) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(result.get('risk_percentage', 0)) }}%
                            </div>
                        </div>
                        <small class="text-muted">{{ t('results.riskProbability') }}: {{ "%.1f"|format(result.get('risk_percentage', 0)) }}%</small>
                        {% endif %}
                    </div>

                    <!-- Model Type -->
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-cogs me-1"></i>
                            {{ result.get('model_type', t('results.unknownModel')) }}
                        </small>
                    </div>

                    <!-- AFP Enhancement Notice for HCC -->
                    {% if disease_key == 'hcc' and has_afp %}
                    <div class="mt-3">
                        <div class="alert alert-info alert-sm" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>{{ t('results.enhancedPrediction') }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Traditional Clinical Scores -->
    {% if traditional_scores %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>{{ t('results.traditionalScores') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for score_name, score_value in traditional_scores.items() %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-{{ score_interpretations[score_name]['color'] }} text-white text-center py-2">
                                    <h6 class="mb-0">
                                        {{ score_name }}
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           data-bs-html="true"
                                           title="{% if score_name == 'FIB-4' %}
                                               <strong>{{ t('tooltips.fib4.title') }}</strong><br>
                                               {{ t('tooltips.fib4.description') }}<br>
                                               {{ t('tooltips.fib4.formula') }}<br>
                                               {% for range in t('tooltips.fib4.ranges') %}{{ range }}<br>{% endfor %}
                                           {% elif score_name == 'APRI' %}
                                               <strong>{{ t('tooltips.apri.title') }}</strong><br>
                                               {{ t('tooltips.apri.description') }}<br>
                                               {{ t('tooltips.apri.formula') }}<br>
                                               {% for range in t('tooltips.apri.ranges') %}{{ range }}<br>{% endfor %}
                                           {% elif score_name == 'MELD' %}
                                               <strong>{{ t('tooltips.meld.title') }}</strong><br>
                                               {{ t('tooltips.meld.description') }}<br>
                                               {{ t('tooltips.meld.purpose') }}<br>
                                               {{ t('tooltips.meld.formula') }}<br>
                                               {% for range in t('tooltips.meld.ranges') %}{{ range }}<br>{% endfor %}
                                           {% elif score_name == 'Child-Pugh Score' %}
                                               <strong>{{ t('tooltips.childPughScore.title') }}</strong><br>
                                               {{ t('tooltips.childPughScore.description') }}<br>
                                               {{ t('tooltips.childPughScore.parameters') }}<br>
                                               {{ t('tooltips.childPughScore.scoring') }}<br>
                                               {{ t('tooltips.childPughScore.total') }}<br>
                                               {% for range in t('tooltips.childPughScore.ranges') %}{{ range }}<br>{% endfor %}
                                           {% elif score_name == 'Child-Pugh Class' %}
                                               <strong>{{ t('tooltips.childPughClass.title') }}</strong><br>
                                               {{ t('tooltips.childPughClass.description') }}<br>
                                               <strong>{{ t('tooltips.childPughClass.classA.title') }}</strong><br>
                                               {% for survival in t('tooltips.childPughClass.classA.survival') %}- {{ survival }}<br>{% endfor %}
                                               <strong>{{ t('tooltips.childPughClass.classB.title') }}</strong><br>
                                               {% for survival in t('tooltips.childPughClass.classB.survival') %}- {{ survival }}<br>{% endfor %}
                                               <strong>{{ t('tooltips.childPughClass.classC.title') }}</strong><br>
                                               {% for survival in t('tooltips.childPughClass.classC.survival') %}- {{ survival }}{% if not loop.last %}<br>{% endif %}{% endfor %}
                                           {% elif score_name == 'BMI Category' %}
                                               <strong>{{ t('tooltips.bmi.title') }}</strong><br>
                                               {{ t('tooltips.bmi.description') }}<br>
                                               {% for range in t('tooltips.bmi.ranges') %}{{ range }}{% if not loop.last %}<br>{% endif %}{% endfor %}
                                           {% endif %}"
                                           style="cursor: pointer;">
                                        </i>
                                    </h6>
                                </div>
                                <div class="card-body text-center py-2">
                                    <div class="h4 mb-1">
                                        {% if score_value is number %}
                                            {{ "%.2f"|format(score_value) }}
                                        {% else %}
                                            {{ score_value }}
                                        {% endif %}
                                    </div>
                                    <div class="badge bg-{{ score_interpretations[score_name]['color'] }} mb-2">
                                        {{ score_interpretations[score_name]['level'] }}
                                    </div>
                                    <div class="small text-muted">
                                        {{ score_interpretations[score_name]['interpretation'] }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Risk Interpretation Guide -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>{{ t('results.clinicalInterpretation') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-success me-2">{{ t('results.low') }}</span>
                                <span class="text-muted">{{ t('results.lowProbabilityRange') }}</span>
                            </div>
                            <small class="text-muted">{{ t('results.lowRiskDesc') }}</small>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-warning me-2">{{ t('results.moderate') }}</span>
                                <span class="text-muted">{{ t('results.moderateProbabilityRange') }}</span>
                            </div>
                            <small class="text-muted">{{ t('results.moderateRiskDesc') }}</small>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-danger me-2">{{ t('results.high') }}</span>
                                <span class="text-muted">{{ t('results.highProbabilityRange') }}</span>
                            </div>
                            <small class="text-muted">{{ t('results.highRiskDesc') }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Doctor Assessment Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-md me-2"></i>{{ t('results.aiAssessmentTitle') }}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        {{ t('results.aiAssessmentDesc') }}
                    </p>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="doctorSelect" class="form-label">{{ t('results.selectAIDoctor') }}</label>
                            <select class="form-select" id="doctorSelect">
                                <option value="">{{ t('results.chooseDoctor') }}</option>
                                <option value="smith">{{ t('drclaude') }} (Claude 3 Haiku)</option>
                                <option value="johnson">{{ t('drgpt') }} (GPT-4o)</option>
                                <option value="brown">{{ t('drgemini') }} (Gemini 2.5 Flash)</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="getAssessmentBtn" onclick="getAIAssessment()">
                                <i class="fas fa-square-poll-vertical me-2"></i>{{ t('results.getAssessment') }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading spinner -->
                    <div id="assessmentLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{{ t('form.gettingAssessment') }}</span>
                        </div>
                        <p class="mt-2 text-muted">{{ t('form.aiAnalyzing') }}</p>
                    </div>
                    
                    <!-- AI Assessment Result -->
                    <div id="aiAssessmentResult" style="display: none;">
                        <hr>
                        <div class="alert alert-light border border-primary">
                            <h6 id="assessmentTitle" class="text-primary mb-3"></h6>
                            <div id="assessmentContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>{{ t('results.medicalDisclaimer') }}</strong> {{ t('results.disclaimerText') }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <a href="/" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-calculator me-2"></i>{{ t('results.newAssessment') }}
            </a>
            <button class="btn btn-secondary btn-lg" onclick="requestServerPDF()">
                <i class="fas fa-file-pdf me-2"></i>{{ t('results.printResults') }}
            </button>
        </div>
    </div>

    <!-- Hidden JSON for PDF export -->
    <script id="pdf-data-json" type="application/json">
        {{ {
            'patient': patient_data,
            'lab': lab_data if lab_data is defined else [],
            'risk': risk_data if risk_data is defined else [],
            'scores': scores_data if scores_data is defined else [],
            'ai_assessment': ai_assessment if ai_assessment is defined else ''
        } | tojson }}
    </script>
</div>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            placement: 'top'
        });
    });
});

// AI Assessment functionality
function getAIAssessment() {
    const doctorSelect = document.getElementById('doctorSelect');
    const selectedDoctor = doctorSelect.value;
    
    if (!selectedDoctor) {
        alert('Please select a doctor first.');
        return;
    }
    
    // Show loading spinner
    document.getElementById('assessmentLoading').style.display = 'block';
    document.getElementById('aiAssessmentResult').style.display = 'none';
    document.getElementById('getAssessmentBtn').disabled = true;
    
    // Make AJAX request to get AI assessment
    fetch('/get_ai_assessment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            doctor: selectedDoctor
        })
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading spinner
        document.getElementById('assessmentLoading').style.display = 'none';
        document.getElementById('getAssessmentBtn').disabled = false;
        
        if (data.success) {
            // Display the assessment
            document.getElementById('assessmentTitle').textContent = data.title;
            document.getElementById('assessmentContent').innerHTML = data.assessment;
			window.aiResp = data.assessment;
            document.getElementById('aiAssessmentResult').style.display = 'block';
            
            // Scroll to the assessment result
            document.getElementById('aiAssessmentResult').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('assessmentLoading').style.display = 'none';
        document.getElementById('getAssessmentBtn').disabled = false;
        alert('An error occurred while getting the AI assessment.');
    });
}
</script>
{% endblock %}
